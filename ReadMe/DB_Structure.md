# Динамически формируемая структура БД и источники данных

Этот документ описывает структуру файла `db.json`, которая формируется динамически в процессе работы приложения, а также указывает, каким образом данные попадают в эту структуру.

## Основная структура `db.json`

`db.json` представляет собой корневой JSON-объект, содержащий единственный ключ `users`.

```json
{
  "users": {
    "[X-Telegram-User-ID]": {
      "dreams": [
        // Массив объектов снов, каждый из которых является результатом интерпретации.
        // Пример структуры объекта сна:
        {
          "id": "<UUID>",
          "date": "YYYY-MM-DD",
          "originalText": "<Текст сна пользователя>",
          "activeLens": null, // или ключ линзы: "psychoanalytic" | "tarot" | "astrology" | "culturology"
          "title": "<Сгенерированное ИИ название сна>",
          "keyImages": ["<изображение1>", "<изображение2>"],
          "snapshotSummary": "<Краткое резюме интерпретации>",
          "lenses": {
            "psychoanalytic": {
              // ... структура психоаналитической линзы
            },
            "esoteric": { /* ... детали интерпретации ... */ },
            "astrology": {
              "title": "Астрология",
              "celestialMap": { /* ... */ },
              "analysis": { /* ... */ },
              "topTransits": [ /* ... */ ],
              "explanation": "<Текст-подсказка для пользователя>",
              "cosmicPassport": {
                "title": "Ваш Космический Паспорт",
                "sun": {
                  "title": "Солнце в знаке <Название знака>",
                  "tagline": "<Статический текст-теглайн для знака>",
                  "interpretation": "<Интерпретация от LLM (пока mock)>",
                  "recommendation": "<Рекомендация от LLM (пока mock)>"
                },
                "moon": {
                  "title": "Луна в знаке <Название знака>",
                  "tagline": "<Статический текст-теглайн для знака>",
                  "interpretation": "<Интерпретация от LLM (пока mock)>",
                  "recommendation": "<Рекомендация от LLM (пока mock)>"
                }
              },
              "state": {
                "viewedInsights": [0, 1, 2],           // индексы просмотренных слайдов (0 — плейсхолдер)
                "isSummaryUnlocked": true,              // финальный совет показан (пропустить анимации при повторном визите)
                "currentIndex": 3                       // последний активный слайд карусели
              }
            },
            "culturology": {
              "title": "Культурный Код",
              "preface": {
                "title": "Макро-анализ Сновидения",
                "content": "Markdown text for the preface..."
              },
              "analysis": [
                {
                  "title": "Архетип: Дорогостоящая Ошибка",
                  "content": "Markdown text analyzing the first archetype..."
                },
                {
                  "title": "Архетип: Неожиданный Мудрец",
                  "content": "Markdown text analyzing the second archetype..."
                }
              ],
              "insight": {
                "title": "Ключевой Инсайт и Практический Совет",
                "content": "Markdown text for the key insight...",
                "recommendation": "Markdown text for the practical advice..."
              }
            },
            "tarot": {
              "title": "Таро",
              "spread": [ /* 5 карт */ ],
              "summary": "<Общий смысл>",
              "state": {
                "isRevealed": true // карты уже раскрыты
              }
            }
          }
        }
        // ... другие объекты снов ...
      ],
      "profile": {
        "birthDate": "YYYY-MM-DD",
        "birthTime": "HH:MM",
        "birthPlace": "<Город, Страна>",
        "birthLatitude": "<Широта>",
        "birthLongitude": "<Долгота>"
      }
    },
    // ... другие пользователи ...
  }
}
```

## Источники данных и динамическое формирование

... (Разделы без изменений) ...

*   `astrology`:
    *   `celestialMap`, `analysis`, `topTransits`: Генерируются сервисом `astrology.js`.
    *   `cosmicPassport`: Генерируется новой функцией `getCosmicPassport` в `astrology.js`. Она определяет знаки Солнца и Луны из `natalChart` пользователя и подбирает соответствующие статические теглайны. Интерпретация и рекомендация пока являются моковыми, но предназначены для генерации LLM.
    *   `state`: Обновляется через API при действиях пользователя (листание слайдов, открытие финального совета). Хранит прогресс UI.

*   `tarot`:
    *   `spread`, `summary`: Формируются на бэкенде (LLM/моки).
    *   `state.isRevealed`: Обновляется через API при первом раскрытии карт.


## Важные замечания для разработки (Mistakes to Avoid)

В процессе разработки и отладки были выявлены критические моменты, требующие особого внимания.

### 1. Расчет Натальной Карты и Зависимость от Геокодирования
*   **Проблема:** Расчет натальной карты (`natalChart`) зависит от `birthDate`, `birthTime`, `birthLatitude` и `birthLongitude`. Координаты получаются через **Google Geocoding API**.
*   **Ключевой момент:** Расчет молча провалится, если `GOOGLE_GEOCODING_API_KEY` в `.env` отсутствует или невалиден.
*   **Рекомендация:** При отладке проблем с `natalChart` в первую очередь проверяйте консоль бэкенда на наличие ошибок от Google Geocoding API. **Код должен быть устойчив к отсутствию координат: расчет натальной карты следует запускать только *после* успешной проверки наличия `birthLatitude` и `birthLongitude`, чтобы избежать падения сервера, если геокодирование не удалось.**

### 2. Формат Даты Рождения
*   **Проблема:** Фронтенд отправляет дату в формате `ДД.ММ.ГГГГ`. Бэкенд должен быть готов к этому.
*   **Ключевой момент:** Несоответствие форматов дат приводило к сбою всех астрологических расчетов.
*   **Рекомендация:** Всегда сверять форматы дат между фронтендом и бэкендом.

### 3. Настройка `nodemon` и `db.json`
*   **Проблема:** `nodemon` по умолчанию перезапускает сервер при изменении `db.json`, что мешает отладке.
*   **Решение:** Скрипт `dev` в `backend/package.json` содержит флаг `--ignore db.json`.
*   **Рекомендация:** Не изменяйте эту настройку.

### 4. Использование `react-markdown`
*   **Проблема:** Начиная с последних версий, библиотека `react-markdown` больше не принимает проп `className` напрямую. Попытка передать его вызывает ошибку и "белый экран".
*   **Решение:** Для стилизации вывода от `react-markdown` необходимо обернуть компонент в родительский `div` и применить классы к этому `div`.
    ```jsx
    // НЕПРАВИЛЬНО:
    // <ReactMarkdown className={styles.markdown}>...</ReactMarkdown>
    
    // ПРАВИЛЬНО:
    <div className={styles.markdown}>
        <ReactMarkdown>...</ReactMarkdown>
    </div>
    ```
*   **Рекомендация:** Всегда использовать обертку `div` для стилизации компонента `ReactMarkdown`, чтобы избежать проблем совместимости версий.

### 5. Рекомендации по Промпту для LLM (Блок "Космический Паспорт")
### 6. Сохранение UI-состояния линз
*   **Что сохранять:** `activeLens` на уровне сна; для `astrology.state` — `viewedInsights`, `isSummaryUnlocked`, `currentIndex`; для `tarot.state` — `isRevealed`.
*   **Рекомендация:** При монтировании страниц восстанавливать эти значения из БД, чтобы пользователь продолжал «с той же главы».

### 7. Backward compatibility
*   **Проблема:** Старые записи в `db.json` могут не иметь новых полей `activeLens`/`state`.
*   **Решение:** Всегда проверять наличие поля перед доступом и использовать безопасные дефолты. При первом действии пользователя — записывать новое состояние через API.

### 8. Строгий режим React и анимации
*   **Проблема:** Таймеры и пошаговые анимации могут сработать дважды.
*   **Решение:** Для критичных UI-состояний (например, первое раскрытие Таро) используйте детерминированное мгновенное отображение, либо делайте анимации идемпотентными.

### 9. API-клиент и прокси
*   **Рекомендация:** Использовать общий `api` клиент (axios) для всех запросов (заголовок `X-Telegram-User-ID`, прокси `/api`). Не миксовать с `fetch` и абсолютными URL. **Важно помнить: если бэкенд-сервер падает при запуске (например, из-за синтаксической ошибки), Vite proxy не сможет к нему подключиться. На фронтенде это проявится как ошибка `ECONNREFUSED` в консоли Vite и `500 Internal Server Error` в браузере. Ошибка 500 на фронте не всегда означает ошибку в логике эндпоинта — в первую очередь нужно проверить, что бэкенд вообще запустился.**

### 10. Порядок снов
*   **Замечание:** Не используйте мутирующий `reverse()` на массиве, который затем может быть записан. Если нужен обратный порядок — применяйте `slice().reverse()`.

### 11. Единообразие Модульной Системы (ESM vs CommonJS)
*   **Проблема:** Смешивание синтаксиса импортов (`import/export` из ESM) и (`require/module.exports` из CommonJS) в рамках одного Node.js приложения приводит к `SyntaxError` и падению сервера при старте.
*   **Решение:** Весь бэкенд-код должен придерживаться единого стандарта. В данном проекте используется ESM (`import/export`). При добавлении новых файлов или рефакторинге старых необходимо следовать этому синтаксису.

### 12. Порядок снов
*   **Замечание:** Не используйте мутирующий `