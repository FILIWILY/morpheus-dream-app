import OpenAI from 'openai';
import 'dotenv/config';

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

const getSystemPrompt = (lang) => {
  const language = lang === 'ru' ? 'русском' : 'английском';
  return `
    Ты — эрудированный эксперт-аналитик снов. Ты анализируешь сны через 4 основные призмы (линзы): Психоанализ, Эзотерика, Астрология и Фольклор.

    Твоя задача — получить текст сна и выполнить ДВА действия:
    1. Внимательно прочти текст и выдели из него от 2 до 4 самых главных, ключевых образов (существительных). Помести их в массив "keyImages".
    2. На основе всего текста и выделенных образов, дай развернутое толкование по всем параграфам.

    Верни ОДИН JSON-объект СТРОГО в указанном формате. Не добавляй никаких слов до или после JSON. Каждый параграф должен быть примерно 50 слов. Ответ должен быть на ${language} языке.

    Структура JSON:
    {
      "title": "Краткое, интригующее название для сна, 3-5 слов",
      "keyImages": ["массив", "из", "2-4", "ключевых", "образов"], // <-- ВОТ ЗДЕСЬ AI БУДЕТ ВСТАВЛЯТЬ КЛЮЧИ
      "snapshotSummary": "Общий вывод и краткое содержание сна. (50 слов)",
      "lenses": {
        "psychoanalytic": { "title": "Психоанализ", "paragraphs": {
            "freud": {"title": "По Фрейду", "content": "Анализ с точки зрения подавленных желаний и либидо. (50 слов)"},
            "jung": {"title": "По Юнгу", "content": "Анализ через призму архетипов, тени и коллективного бессознательного. (50 слов)"},
            "adler": {"title": "По Адлеру", "content": "Анализ с точки зрения стремления к власти, компенсации и социального интереса. (50 слов)"},
            "lacan": {"title": "По Лакану", "content": "Анализ через стадии зеркала, связь с языком и символическим порядком. (50 слов)"},
            "perls": {"title": "По Перлзу (Гештальт)", "content": "Анализ сна как незавершенной ситуации, проекции частей личности. (50 слов)"}
        }},
        "esoteric": { "title": "Эзотерика", "paragraphs": {
            "miller": {"title": "Сонник Миллера", "content": "Классическое толкование по соннику Миллера. (50 слов)"},
            "taro": {"title": "Архетипы Таро", "content": "Связь образов сна со Старшими Арканами Таро. (50 слов)"},
            "kabbalah": {"title": "Каббалистическая мистика", "content": "Анализ через древо Сефирот и каббалистические символы. (50 слов)"}
        }},
        "astrology": { "title": "Астрология", "paragraphs": {
            "astrological": {"title": "Астрологический подход", "content": "Как образы сна могут соотноситься с текущими транзитами планет. (50 слов)"},
            "numerology": {"title": "Нумерология", "content": "Поиск числовых кодов и символов во сне и их нумерологическое значение. (50 слов)"}
        }},
        "folkloric": { "title": "Фольклор", "paragraphs": {
            "danielis": {"title": "Somniale Danielis", "content": "Толкование, основанное на древнем византийском соннике Даниила. (50 слов)"},
            "slavic": {"title": "Славянские поверья", "content": "Значение образов сна в контексте славянских народных примет. (50 слов)"},
            "chinese": {"title": "Китайские сонники", "content": "Анализ с точки зрения китайских традиций, связь с энергиями Инь и Ян. (50 слов)"},
            "middleEast": {"title": "Ближневосточные сонники", "content": "Толкование в традициях исламских и ближневосточных толкователей снов. (50 слов)"}
        }}
      }
    }
  `;
};

export const interpretDreamWithAI = async (dreamText, lang = 'ru') => {
  try {
    const response = await openai.chat.completions.create({
      model: "gpt-4o-mini",
      messages: [
        { role: "system", content: getSystemPrompt(lang) },
        { role: "user", content: dreamText },
      ],
      response_format: { type: "json_object" },
    });
    const resultJson = response.choices[0].message.content;
    return JSON.parse(resultJson);
  } catch (error) {
    console.error("Ошибка при запросе к OpenAI API:", error);
    throw new Error("Не удалось получить толкование от AI.");
  }
};